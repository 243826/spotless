# BUILDCACHE_USER
# BUILDCACHE_PASS
#   - rw access to buildcache.diffplug.com

on:
  pull_request:
  push:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  testClasses:
    name: spotlessCheck assemble testClasses
    runs-on: ubuntu-latest
    env:
      buildcacheuser: ${{ secrets.BUILDCACHE_USER }}
      buildcachepass: ${{ secrets.BUILDCACHE_PASS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 11
          cache: gradle
      - name: spotlessCheck
        run: ./gradlew spotlessCheck --build-cache
      - name: assemble testClasses
        run: ./gradlew assemble testClasses --build-cache -PSPOTLESS_EXCLUDE_MAVEN=true
        # If this gets resolved, remove the EXCLUDE_MAVEN https://github.com/diffplug/spotless/issues/554
  check:
    needs: testClasses
    strategy:
      fail-fast: false
      matrix:
        kind: [maven, gradle, npm]
        jre: [8, 11, 17]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install JDK ${{ matrix.distribution }} ${{ matrix.java_version }}
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ matrix.jre }}
          cache: gradle
      - name: check maven
        if: matrix.kind == 'maven'
        run: ./gradlew :plugin-maven:check -x spotlessCheck --build-cache
      - name: check everything but maven
        if: matrix.kind == 'gradle'
        run: ./gradlew check -x spotlessCheck --build-cache -PSPOTLESS_EXCLUDE_MAVEN=true
      - name: check npm
        if: matrix.kind == 'npm'
        run: ./gradlew testNpm --build-cache
