# BUILDCACHE_USER
# BUILDCACHE_PASS
#   - rw access to buildcache.diffplug.com

on: [push, pull_request]
jobs:
  testClasses:
    name: spotlessCheck assemble testClasses
    runs-on: ubuntu-latest
    env:
      buildcacheuser: ${{ secrets.BUILDCACHE_USER }}
      buildcachepass: ${{ secrets.BUILDCACHE_PASS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 11
          cache: gradle
      - name: spotlessCheck
        run: ./gradlew spotlessCheck --build-cache
      - name: assemble testClasses
        run: export SPOTLESS_EXCLUDE_MAVEN=true && ./gradlew assemble testClasses --build-cache
        # If this gets resolved, remove the EXCLUDE_MAVEN https://github.com/diffplug/spotless/issues/554
  check:
    needs: testClasses
    strategy:
      fail-fast: false
      matrix:
        maven_or_gradle: [maven, gradle]
        os: [ubuntu-latest, windows-latest]
        jre: [11, 17]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install JDK ${{ matrix.distribution }} ${{ matrix.java_version }}
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ matrix.jre }}
          cache: gradle
      - name: check maven
        if: matrix.maven_or_gradle == 'maven'
        run: ./gradlew :plugin-maven:check -x spotlessCheck --build-cache
      - name: check everything but maven
        if: matrix.maven_or_gradle == 'gradle'
        run: export SPOTLESS_EXCLUDE_MAVEN=true && ./gradlew check -x spotlessCheck --build-cache
